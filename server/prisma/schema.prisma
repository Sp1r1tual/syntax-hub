generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                    String           @id @default(uuid())
  email                 String           @unique
  name                  String?
  avatar                String?
  roles                 UserRole[]
  refreshTokens         RefreshToken[]
  createdCourses        Course[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@map("users")
}

model Role {
  id                    String           @id @default(uuid())
  key                   String           @unique 
  title                 String
  users                 UserRole[]
  createdAt             DateTime         @default(now())

  @@map("roles")
}

model UserRole {
  userId String
  roleId String
  user                  User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  role                  Role             @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  @@id([userId, roleId])
  @@map("user_roles")
}

model RefreshToken {
  id                    String            @id @default(uuid())
  token                 String            @unique
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt             DateTime
  createdAt             DateTime          @default(now())

  @@map("refresh_tokens")
}

model CategoryGroup {
  id                    String            @id @default(uuid())
  key                   String            @unique
  title                 String
  order                 Int               @default(999)
  courses               Course[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([order])
  @@map("category_groups")
}

model Course {
  id                    String            @id @default(uuid())
  slug                  String            @unique
  groupId               String
  group                 CategoryGroup     @relation(fields: [groupId], references: [id], onDelete: Restrict)
  title                 String
  description           String?
  icon                  String?
  authorId              String?
  author                User?             @relation(fields: [authorId], references: [id], onDelete: SetNull)
  topics                Topic[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([groupId])
  @@index([authorId])
  @@index([order])
  @@map("courses")
}

model Topic {
  id                    String            @id @default(uuid())
  title                 String
  courseId              String
  course                Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions             Question[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([courseId])
  @@index([order])
  @@map("topics")
  @@unique([courseId, order])
}

model Question {
  id                    String            @id @default(uuid())
  text                  String            @db.Text
  topicId               String
  topic                 Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)
  blocks                ContentBlock[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([topicId])
  @@index([order])
  @@map("questions")
  @@unique([topicId, order])
}

enum ContentBlockType {
  TEXT
  CODE
  NOTE
  IMAGE
  TABLE
}

enum CodeLanguage {
  JAVASCRIPT
  TYPESCRIPT
  HTML
  CSS
  JSON
  BASH
  PYTHON
  JAVA
  CSHARP
  SQL
}

model ContentBlock {
  id                    String            @id @default(uuid())
  questionId            String
  question              Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  type                  ContentBlockType
  content               String?           @db.Text
  language              CodeLanguage?
  src                   String?
  alt                   String?
  caption               String?
  title                 String?
  headers               TableHeader[]
  rows                  TableRow[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([questionId])
  @@index([order])
  @@map("content_blocks")
  @@unique([questionId, order])
}

model TableHeader {
  id                    String            @id @default(uuid())
  contentBlockId        String
  contentBlock          ContentBlock      @relation(fields: [contentBlockId], references: [id], onDelete: Cascade)
  text                  String
  order                 Int               @default(999)

  @@index([contentBlockId])
  @@index([order])
  @@map("table_headers")
  @@unique([contentBlockId, order])
}

model TableRow {
  id                    String            @id @default(uuid())
  contentBlockId        String
  contentBlock          ContentBlock      @relation(fields: [contentBlockId], references: [id], onDelete: Cascade)
  cells                 TableCell[]
  order                 Int               @default(999)

  @@index([contentBlockId])
  @@index([order])
  @@map("table_rows")
  @@unique([contentBlockId, order])
}

model TableCell {
  id                    String            @id @default(uuid())
  rowId                 String
  row                   TableRow          @relation(fields: [rowId], references: [id], onDelete: Cascade)
  text                  String
  order                 Int               @default(999)

  @@index([rowId])
  @@index([order])
  @@map("table_cells")
  @@unique([rowId, order])
}