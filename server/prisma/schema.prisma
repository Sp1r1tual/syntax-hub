generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
  TEACHER
}

enum QuestionStatus {
  REPEAT
  LEARNED
}

model User {
  id                    String           @id @default(uuid())
  email                 String           @unique
  name                  String?
  avatar                String?
  socials               Json? 
  role                  UserRole         @default(USER)
  refreshTokens         RefreshToken[]
  authoredCourses       CourseAuthor[]
  newsLikes             NewsLike[]
  comments              Comment[]
  commentLikes          CommentLike[]
  questionStatuses      UserQuestionStatus[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@map("users")
}

model RefreshToken {
  id                    String            @id @default(uuid())
  token                 String            @unique
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt             DateTime
  createdAt             DateTime          @default(now())

  @@map("refresh_tokens")
}

model CategoryGroup {
  id                    String            @id @default(uuid())
  key                   String            @unique
  title                 String
  order                 Int               @default(999)
  courses               Course[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([order])
  @@map("category_groups")
}

model Course {
  id                    String            @id @default(uuid())
  slug                  String            @unique
  groupId               String
  group                 CategoryGroup     @relation(fields: [groupId], references: [id], onDelete: Restrict)
  title                 String
  description           String?
  icon                  String?
  authors               CourseAuthor[]
  topics                Topic[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([groupId])
  @@index([order])
  @@map("courses")
}

model CourseAuthor {
  id                    String            @id @default(uuid())
  courseId              String
  course                Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())

  @@unique([courseId, userId])
  @@index([courseId])
  @@index([userId])
  @@index([order])
  @@map("course_authors")
}

model Topic {
  id                    String            @id @default(uuid())
  title                 String
  courseId              String
  course                Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions             Question[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([courseId])
  @@index([order])
  @@map("topics")
  @@unique([courseId, order])
}

model Question {
  id                    String            @id @default(uuid())
  text                  String            @db.Text
  topicId               String
  topic                 Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)
  content               String            @db.Text
  comments              Comment[]
  userStatuses          UserQuestionStatus[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([topicId])
  @@index([order])
  @@map("questions")
  @@unique([topicId, order])
}

model UserQuestionStatus {
  id                    String            @id @default(uuid())
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  questionId            String
  question              Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  status                QuestionStatus
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@unique([userId, questionId])
  @@index([userId])
  @@index([questionId])
  @@index([status])
  @@map("user_question_statuses")
}

model News {
  id                    String            @id @default(uuid())
  title                 String            @unique
  content               String            @db.Text
  likes                 Int               @default(0)
  likedBy               NewsLike[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@map("news")
}

model NewsLike {
  id                    String      @id @default(uuid())
  newsId                String
  userId                String
  news                  News        @relation(fields: [newsId], references: [id], onDelete: Cascade)
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime    @default(now())

  @@unique([newsId, userId])
  @@index([userId])
  @@index([newsId])
  @@map("news_likes")
}

model Comment {
  id                    String            @id @default(uuid())
  questionId            String
  question              Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId              String?
  parent                Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies               Comment[]         @relation("CommentReplies")
  text                  String            @db.Text
  images                CommentImage[]
  likes                 CommentLike[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  deletedAt             DateTime?

  @@index([questionId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comments")
}

model CommentImage {
  id                    String            @id @default(uuid())
  commentId             String
  comment               Comment           @relation(fields: [commentId], references: [id], onDelete: Cascade)
  src                   String
  order                 Int               @default(0)
  createdAt             DateTime          @default(now())

  @@index([commentId])
  @@index([order])
  @@map("comment_images")
  @@unique([commentId, order])
}

model CommentLike {
  id                    String            @id @default(uuid())
  commentId             String
  userId                String
  comment               Comment           @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime          @default(now())

  @@unique([commentId, userId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_likes")
}