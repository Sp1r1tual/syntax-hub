generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  ADMIN
  MODERATOR
  TEACHER
}

model User {
  id                    String           @id @default(uuid())
  email                 String           @unique
  name                  String?
  avatar                String?
  role                  UserRole         @default(USER)
  refreshTokens         RefreshToken[]
  createdCourses        Course[]
  newsLikes             NewsLike[]
  comments              Comment[]
  commentLikes          CommentLike[]
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@map("users")
}

model RefreshToken {
  id                    String            @id @default(uuid())
  token                 String            @unique
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt             DateTime
  createdAt             DateTime          @default(now())

  @@map("refresh_tokens")
}

model CategoryGroup {
  id                    String            @id @default(uuid())
  key                   String            @unique
  title                 String
  order                 Int               @default(999)
  courses               Course[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([order])
  @@map("category_groups")
}

model Course {
  id                    String            @id @default(uuid())
  slug                  String            @unique
  groupId               String
  group                 CategoryGroup     @relation(fields: [groupId], references: [id], onDelete: Restrict)
  title                 String
  description           String?
  icon                  String?
  authorId              String?
  author                User?             @relation(fields: [authorId], references: [id], onDelete: SetNull)
  topics                Topic[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([groupId])
  @@index([authorId])
  @@index([order])
  @@map("courses")
}

model Topic {
  id                    String            @id @default(uuid())
  title                 String
  courseId              String
  course                Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  questions             Question[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([courseId])
  @@index([order])
  @@map("topics")
  @@unique([courseId, order])
}

model Question {
  id                    String            @id @default(uuid())
  text                  String            @db.Text
  topicId               String
  topic                 Topic             @relation(fields: [topicId], references: [id], onDelete: Cascade)
  blocks                ContentBlock[]
  comments              Comment[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([topicId])
  @@index([order])
  @@map("questions")
  @@unique([topicId, order])
}

enum ContentBlockType {
  TEXT
  CODE
  NOTE
  IMAGE
  TABLE
  LIST
}

enum CodeLanguage {
  JAVASCRIPT
  TYPESCRIPT
  HTML
  CSS
  JSON
  BASH
  PYTHON
  JAVA
  CSHARP
  SQL
}

model ContentBlock {
  id                    String            @id @default(uuid())
  questionId            String
  question              Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  type                  ContentBlockType
  content               String?           @db.Text
  language              CodeLanguage?
  src                   String?
  alt                   String?
  caption               String?
  title                 String?
  headers               TableHeader[]
  rows                  TableRow[]
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([questionId])
  @@index([order])
  @@map("content_blocks")
  @@unique([questionId, order])
}

model TableHeader {
  id                    String            @id @default(uuid())
  contentBlockId        String
  contentBlock          ContentBlock      @relation(fields: [contentBlockId], references: [id], onDelete: Cascade)
  text                  String
  order                 Int               @default(999)

  @@index([contentBlockId])
  @@index([order])
  @@map("table_headers")
  @@unique([contentBlockId, order])
}

model TableRow {
  id                    String            @id @default(uuid())
  contentBlockId        String
  contentBlock          ContentBlock      @relation(fields: [contentBlockId], references: [id], onDelete: Cascade)
  cells                 TableCell[]
  order                 Int               @default(999)

  @@index([contentBlockId])
  @@index([order])
  @@map("table_rows")
  @@unique([contentBlockId, order])
}

model TableCell {
  id                    String            @id @default(uuid())
  rowId                 String
  row                   TableRow          @relation(fields: [rowId], references: [id], onDelete: Cascade)
  text                  String
  order                 Int               @default(999)

  @@index([rowId])
  @@index([order])
  @@map("table_cells")
  @@unique([rowId, order])
}

model News {
  id                    String            @id @default(uuid())
  title                 String
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  likes                 Int               @default(0)
  likedBy               NewsLike[]     
  blocks                NewsBlock[]    

  @@map("news")
}

model NewsBlock {
  id                    String            @id @default(uuid())
  newsId                String
  news                  News              @relation(fields: [newsId], references: [id], onDelete: Cascade)
  type                  ContentBlockType
  content               String?           @db.Text
  title                 String?
  src                   String?
  alt                   String?
  caption               String?
  order                 Int               @default(999)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  @@index([newsId])
  @@index([order])
  @@map("news_blocks")
}

model NewsLike {
  id                    String      @id @default(uuid())
  newsId                String
  userId                String
  news                  News        @relation(fields: [newsId], references: [id], onDelete: Cascade)
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime    @default(now())

  @@unique([newsId, userId])
  @@index([userId])
  @@index([newsId])
  @@map("news_likes")
}

model Comment {
  id                    String            @id @default(uuid())
  questionId            String
  question              Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentId              String?
  parent                Comment?          @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies               Comment[]         @relation("CommentReplies")
  text                  String            @db.Text
  images                CommentImage[]
  likes                 CommentLike[]
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  deletedAt             DateTime?

  @@index([questionId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comments")
}

model CommentImage {
  id                    String            @id @default(uuid())
  commentId             String
  comment               Comment           @relation(fields: [commentId], references: [id], onDelete: Cascade)
  src                   String
  order                 Int               @default(0)
  createdAt             DateTime          @default(now())

  @@index([commentId])
  @@index([order])
  @@map("comment_images")
  @@unique([commentId, order])
}

model CommentLike {
  id                    String            @id @default(uuid())
  commentId             String
  userId                String
  comment               Comment           @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt             DateTime          @default(now())

  @@unique([commentId, userId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_likes")
}